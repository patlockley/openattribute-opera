<!DOCTYPE html>
<html lang="en">
<head>
	<script>
		
		var url_cache = Array();
		
		var theButton = "";
		
		var childNodes = 0;
		
		var ToolbarUIItemProperties = {
					disabled: true,
					title: "Open Attribute",
					icon: "icons/icon.png",
					popup: {
						href: "popup.html",
						width: 500,
						height: 500
					},
					badge: {
            			display: "none",
            			textContent: "found",
            			color: "white",
                		backgroundColor: "rgba(211, 0, 4, 1)"
          			}
				}		

		function setupConnection(){
					
			theButton = opera.contexts.toolbar.createItem(ToolbarUIItemProperties);
					
			opera.contexts.toolbar.addItem(theButton);	
	
   		}
		
		window.addEventListener("load", setupConnection,false);
		
		function hide_button(){
			
			theButton.disabled = true;
								
			theButton.badge.display = "none";	
			
		}
		
		var curr_data;
		
		function show_button(event){
			
			var focused = opera.extension.tabs.getFocused();
			
			url_cache.push(event.data[1]);
			
			curr_data = event.data[1];
				
			if(widget.preferences.firstrun_show=="yes"){
				
				window_first_run = opera.extension.tabs.create({url: "http://openattribute.com/first-run-opera/"});
				widget.preferences.firstrun_show="no";					
					
			}
				
			theButton.disabled = false;
				
			if (widget.preferences.badge_show == "yes") {
				
				theButton.badge.display = "block";
					
			}
			
			
		}
		
		function get_data(event){
			
			theButton.disabled = false;	
		
			theButton.badge.display = "none";
			
			event.source.postMessage(Array("popup_update", curr_data));			
			
		}
		
		var communicator = "";
		
		function get_focus(){
			
			var focused = opera.extension.tabs.getFocused();
			
			curr_data = "";
			
			if (focused != null) {
			
				for (x = 0; x <= url_cache.length; x++) {
				
					cached_url = url_cache[x];
					
					data_to_send = false;
					
					for (y in cached_url) {
					
						if (y == "url") {
						
							if (focused.url == cached_url.url) {
							
								curr_data = cached_url;
								
							}
							
						}
						
					}
					
				}
				
			}
			
			hide_button();
			
			if (focused != null) {
			
				opera.extension.broadcastMessage(Array("process_page", focused.url));
				
			}

		}
		
		opera.extension.tabs.addEventListener("focus",get_focus,false);	

   		opera.extension.onmessage = function(event){
			
			if(event.data=="hide_button"){
				
				hide_button();
				
			}
			
			if(event.data[0]=="show_button"){
				
				show_button(event);
				
			}
			
			if(event.data == "get_url_and_data"){
				
				get_data(event);			
				
			}		
			
   		}
		
		opera.extension.onconnect = function(event){
			
			communicator = event.source;
		
		}
	
		
	</script>
</head>
<body>

</body>
</html>
